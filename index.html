<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Loop | Enterprise Structure</title>
    
    <!-- Fonts: Inter (Standard for high-end UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: { 
                        brand: {
                            black: '#111827',   // Deep black for headings
                            dark: '#1F2937',    // Dark gray for body
                            gray: '#6B7280',    // Muted text
                            purple: '#8b5cf6',  // Logo Purple (Primary)
                            purpleLight: '#F3E8FF', // Light purple bg
                            bg: '#FAFAFA',      // Premium off-white background
                            border: '#E5E7EB',  // Light border
                        }
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    },
                    borderRadius: {
                        'xl': '12px',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FAFAFA;
            color: #1F2937;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Header / Nav --- */
        .header-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #E5E7EB;
        }

        /* --- Section Markers --- */
        .section-marker {
            width: 4px;
            height: 24px;
            background-color: #8b5cf6;
            border-radius: 4px;
            margin-right: 12px;
        }

        /* --- Card Design (Clean Enterprise) --- */
        .card-ent {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card-ent:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
            border-color: #d8b4fe;
        }

        /* --- Lists --- */
        .list-row {
            padding: 10px 12px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s;
            cursor: pointer;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background-color: #F9FAFB; }

        /* --- Buttons --- */
        .btn-ghost {
            color: #6B7280;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-ghost:hover {
            background-color: #F3F4F6;
            color: #111827;
        }

        /* --- Collapse Logic --- */
        .team-section {
            border-top: 1px solid #E5E7EB;
        }
        .team-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .team-content.expanded {
            max-height: 500px; /* Arbitrary large height */
        }
        .chevron { transition: transform 0.3s ease; }
        .chevron.rotated { transform: rotate(180deg); }

        /* --- Typography --- */
        .text-role { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #8b5cf6; letter-spacing: 0.05em; }
        .text-name { font-size: 15px; font-weight: 600; color: #111827; }

        /* --- Modals --- */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 100;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            .card-ent { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; }
            .team-content { max-height: none !important; display: block !important; }
        }
    </style>
</head>
<body class="pb-20">

    <!-- Sticky Header -->
    <header class="header-bar fixed top-0 w-full z-50 h-16 flex items-center shadow-sm">
        <div class="container mx-auto px-6 max-w-[1600px] flex justify-between items-center">
            <!-- Brand -->
            <div class="flex items-center gap-4 cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <img src="https://i.imgur.com/Paft0Df.png" alt="Traffic Loop" class="h-8 w-auto object-contain">
                <div class="h-6 w-px bg-gray-200"></div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight hidden sm:block">Organization Chart</h1>
            </div>

            <!-- Controls -->
            <div class="flex items-center gap-3 no-print">
                <!-- Search -->
                <div class="relative hidden lg:block">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="globalSearch" placeholder="Search team or member..." 
                           class="pl-10 pr-4 py-2 bg-gray-100 border-none rounded-lg text-sm w-64 focus:ring-2 focus:ring-brand-purple focus:bg-white transition-all outline-none">
                </div>

                <div class="h-6 w-px bg-gray-200 mx-2 hidden sm:block"></div>

                <!-- Filters Button -->
                <button id="filterToggleBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium transition-colors">
                    <i class="fas fa-filter text-gray-500"></i> <span>Filters</span>
                </button>

                <!-- Actions -->
                <button onclick="expandAllTeams()" class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 transition-colors" title="Expand All">
                    <i class="fas fa-expand-alt"></i>
                </button>
                <button onclick="collapseAllTeams()" class="w-9 h-9 flex items-center justify-center bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 transition-colors" title="Collapse All">
                    <i class="fas fa-compress-alt"></i>
                </button>
                <button onclick="exportPDF()" class="flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 text-sm font-medium transition-colors shadow-sm">
                    <i class="fas fa-download"></i> <span class="hidden sm:inline">Export</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Filter Dropdown (Absolute) -->
    <div id="filterPanel" class="fixed top-16 right-0 left-0 bg-white/95 backdrop-blur-xl border-b border-gray-200 z-40 hidden shadow-lg transform transition-all">
        <div class="container mx-auto px-6 py-4 max-w-[1600px] flex flex-wrap items-center gap-4">
            <div class="flex flex-col">
                <label class="text-xs font-semibold text-gray-500 uppercase mb-1">Location</label>
                <select id="locationFilter" class="bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-brand-purple focus:border-brand-purple block w-48 p-2.5">
                    <option value="">All Locations</option>
                </select>
            </div>
            <div class="flex flex-col relative group">
                <label class="text-xs font-semibold text-gray-500 uppercase mb-1">Role</label>
                <button id="roleDropdownBtn" class="bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-brand-purple focus:border-brand-purple w-48 p-2.5 text-left flex justify-between items-center">
                    <span class="truncate selected-role-text">All Roles</span>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div id="roleDropdown" class="absolute top-full left-0 w-64 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden z-50 p-1">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pt-24 max-w-[1600px] org-chart-canvas">
        
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-12">
            <div class="md:col-span-1 bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-gray-900 mb-1">Overview</h2>
                <p class="text-sm text-gray-500">Company Structure</p>
            </div>
            <div class="md:col-span-3 grid grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-members">0</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Total Members</div>
                    </div>
                    <!-- Icon: Neutral / Brand Purple -->
                    <div class="w-10 h-10 bg-purple-50 text-brand-purple rounded-full flex items-center justify-center text-lg"><i class="fas fa-users"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-teams">0</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Active Teams</div>
                    </div>
                    <!-- Icon: Neutral Gray -->
                    <div class="w-10 h-10 bg-gray-50 text-gray-600 rounded-full flex items-center justify-center text-lg"><i class="fas fa-layer-group"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-gray-900" id="stat-locations">3</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Physical Locations</div>
                    </div>
                    <!-- Icon: Neutral Gray -->
                    <div class="w-10 h-10 bg-gray-50 text-gray-600 rounded-full flex items-center justify-center text-lg"><i class="fas fa-map-marker-alt"></i></div>
                </div>
            </div>
        </div>

        <!-- Executives -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-16 max-w-5xl mx-auto">
            <!-- GM -->
            <div class="card-ent p-6 flex items-center gap-6 cursor-pointer clickable-person hover:ring-2 hover:ring-brand-purple/20" 
                 data-name="Salaheddine Elyaakoubi" data-role="Manager" data-location="California (Avenue Banafsaj)" data-telegram="@Salaheddine_elyakoubi">
                <div class="w-20 h-20 rounded-full bg-gray-900 text-white flex items-center justify-center text-2xl font-bold shadow-md">SE</div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Salaheddine Elyaakoubi</h3>
                    <p class="text-brand-purple font-semibold text-sm uppercase tracking-wide mb-2">General Manager</p>
                    <div class="flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full w-fit">
                        <i class="fas fa-globe-americas"></i> Global Operations
                    </div>
                </div>
            </div>
            <!-- HR -->
            <div class="card-ent p-6 flex items-center gap-6 cursor-pointer clickable-person hover:ring-2 hover:ring-brand-purple/20" 
                 data-name="Ibrahim EL Maimouni" data-role="HR Manager" data-location="California (Avenue Banafsaj)" data-telegram="@Ibrahim_Elmimouni">
                <div class="w-20 h-20 rounded-full bg-gray-400 text-white flex items-center justify-center text-2xl font-bold shadow-md">IE</div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Ibrahim EL Maimouni</h3>
                    <p class="text-brand-purple font-semibold text-sm uppercase tracking-wide mb-2">HR Manager</p>
                    <div class="flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full w-fit">
                        <i class="fas fa-building"></i> Headquarters
                    </div>
                </div>
            </div>
        </div>

        <!-- Specialized Units -->
        <div class="mb-16" data-location="Special Departments (California)">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="section-marker"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Specialized Units</h2>
                </div>
                <!-- Updated Map URL to match California (Avenue Banafsaj) -->
                <button class="text-sm font-medium text-gray-500 hover:text-brand-purple transition-colors flex items-center gap-2 location-map-btn" 
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.7368258798906!2d-5.8449250237249295!3d35.78184052443994!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0c79a01a02e7a7%3A0x3742104ecd03499a!2sTraffic%20loop%20solutions!5e0!3m2!1sen!2sma!4v1746104811818!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt"></i> View Map
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Technician -->
                <div class="card-ent entity-box" data-entity="Technician">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded uppercase">Tech</span>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    <div class="list-row clickable-person" data-name="Mohamed Alaoui" data-role="Tech Lead" data-team="Technician" data-telegram="+212636203456">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center text-xs font-bold">M</div>
                            <div>
                                <div class="text-name text-sm">Mohamed Alaoui</div>
                                <div class="text-role text-[10px]">Lead</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Offers -->
                <div class="card-ent entity-box" data-entity="Offers Team">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded uppercase">Offers</span>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    <div class="bg-white">
                        <div class="flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                            <span class="text-xs font-medium text-gray-500 uppercase">View Members</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                        </div>
                        <div class="team-content">
                            <div class="list-row clickable-person" data-name="Bouchra Merroun" data-role="Offers" data-telegram="@B_chra">
                                <span class="text-sm font-medium">Bouchra Merroun</span>
                            </div>
                         </div>
                        </div>
                    </div>
                </div>

                <!-- Security -->
                <div class="card-ent entity-box" data-entity="Security">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded uppercase">Security</span>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    <div class="bg-white">
                        <div class="flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                            <span class="text-xs font-medium text-gray-500 uppercase">View Staff</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                        </div>
                        <div class="team-content">
                            <div class="list-row clickable-person" data-name="Abdelmoumen" data-role="Security">
                                <span class="text-sm font-medium">Abdelmoumen</span>
                            </div>
                            <div class="list-row clickable-person" data-name="Hamid" data-role="Security">
                                <span class="text-sm font-medium">Hamid</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cleaning -->
                <div class="card-ent entity-box" data-entity="Cleaning">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded uppercase">Cleaning</span>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    <div class="bg-white">
                        <div class="flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                            <span class="text-xs font-medium text-gray-500 uppercase">View Staff</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                        </div>
                        <div class="team-content">
                            <div class="list-row clickable-person" data-name="Mounia" data-role="Cleaning">
                                <span class="text-sm font-medium">Mounia</span>
                            </div>
                            <div class="list-row clickable-person" data-name="Aziza" data-role="Cleaning">
                                <span class="text-sm font-medium">Aziza</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- California Operations -->
        <div class="mb-16" data-location="California (Avenue Banafsaj)">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="section-marker"></div>
                    <h2 class="text-2xl font-bold text-gray-900">California (Avenue Banafsaj)</h2>
                </div>
                <button class="text-sm font-medium text-gray-500 hover:text-brand-purple transition-colors flex items-center gap-2 location-map-btn"
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.7368258798906!2d-5.8449250237249295!3d35.78184052443994!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0c79a01a02e7a7%3A0x3742104ecd03499a!2sTraffic%20loop%20solutions!5e0!3m2!1sen!2sma!4v1746104811818!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt"></i> View Map
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- GML -->
                <div class="card-ent entity-box" data-entity="GML">
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center gap-3 clickable-person cursor-pointer" data-name="Hicham Mennour" data-role="Supervisor" data-telegram="@hichamwork">
                            <div class="w-10 h-10 rounded bg-gray-900 text-white flex items-center justify-center text-xs font-bold">HM</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-base">GML</h4>
                                <div class="text-[10px] text-gray-500 uppercase font-semibold">Hicham Mennour</div>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    
                    <div class="team-section">
                        <!-- Others Team -->
                        <div class="border-b border-gray-100">
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Others Team</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Mohamed Khallouqi" data-telegram="@M_med_018"><span class="text-sm">Mohamed Khallouqi</span></div>
                                <div class="list-row clickable-person" data-name="Ihab Lamsaadi" data-telegram="@ihablams"><span class="text-sm">Ihab Lamsaadi</span></div>
                                <div class="list-row clickable-person" data-name="Khalid Touil" data-telegram="@koli78"><span class="text-sm">Khalid Touil</span></div>
                                <div class="list-row clickable-person" data-name="Nadir Elabid" data-telegram="+212691936017"><span class="text-sm">Nadir Elabid</span></div>
                            </div>
                        </div>
                        <!-- Gmail Team -->
                        <div>
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Gmail Team</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Akram Mlouki" data-role="Team Leader"><span class="text-sm font-semibold">Akram Mlouki (Lead)</span></div>
                                <div class="list-row clickable-person" data-name="Oumaima El Moussaoui" data-telegram="@ELMusauiOumaima"><span class="text-sm">Oumaima El Moussaoui</span></div>
                                <div class="list-row clickable-person" data-name="Charif Edrissi" data-telegram="+212680743979"><span class="text-sm">Charif Edrissi</span></div>
                                <div class="list-row clickable-person" data-name="Khalid Mesbah" data-telegram="@khaledeeev"><span class="text-sm">Khalid Mesbah</span></div>
                                <div class="list-row clickable-person" data-name="Imane Laboudi" data-telegram="@imane_laboudi"><span class="text-sm font-medium">Imane Laboudi</span></div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GMK -->
                <div class="card-ent entity-box" data-entity="GMK">
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center gap-3 clickable-person cursor-pointer" data-name="Hamza Fellah" data-role="Supervisor" data-telegram="+212677510391">
                            <div class="w-10 h-10 rounded bg-gray-900 text-white flex items-center justify-center text-xs font-bold">HF</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-base">GMK</h4>
                                <div class="text-[10px] text-gray-500 uppercase font-semibold">Hamza Fellah</div>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    
                    <div class="team-section">
                        <!-- Hotmail Team -->
                        <div class="border-b border-gray-100">
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Hotmail Team</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Marouane Latif" data-role="Team Leader" data-telegram="@marouanLatif"><span class="text-sm font-semibold">Marouane Latif (Lead)</span></div>
                                <div class="list-row clickable-person" data-name="Mhamed Gssayer" data-telegram="@Mhagsa"><span class="text-sm">Mhamed Gssayer</span></div>
                            </div>
                        </div>
                        <!-- Gmail Team -->
                        <div>
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Gmail Team</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Haitam Oullad Benhammou" data-role="Team Leader" data-telegram="@haitamouladbenhamou"><span class="text-sm font-semibold">Haitam O. Benhammou</span></div>
                                <div class="list-row clickable-person" data-name="Bouchra S'bai" data-telegram="+212698117856"><span class="text-sm">Bouchra S'bai</span></div>
                                <div class="list-row clickable-person" data-name="Naim Bellali" data-telegram="@Theusers212"><span class="text-sm">Naim Bellali</span></div>
                                <div class="list-row clickable-person" data-name="Houda Rossi"><span class="text-sm">Houda Rossi</span></div>
                                <div class="list-row clickable-person" data-name="Firdaous El Harrak" data-telegram="@hk_firdaous"><span class="text-sm">Firdaous El Harrak</span></div>
                                <div class="list-row clickable-person" data-name="Nadia Samadi" data-telegram="@NadiiaSamadi"><span class="text-sm">Nadia Samadi</span></div>
                                <div class="list-row clickable-person" data-name="Yasir Babahammou" data-telegram="@babahammouyassir"><span class="text-sm">Yasir Babahammou</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GM2 -->
                <div class="card-ent entity-box" data-entity="GM2">
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center gap-3 clickable-person cursor-pointer" data-name="Ismail Semlali" data-role="Supervisor" data-telegram="@esmaelwork">
                            <div class="w-10 h-10 rounded bg-gray-900 text-white flex items-center justify-center text-xs font-bold">IS</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-base">GM2</h4>
                                <div class="text-[10px] text-gray-500 uppercase font-semibold">Ismail Semlali</div>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    
                    <div class="team-section">
                        <div>
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Gmail Inbox</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Mehdi Kazman" data-role="Team Leader" data-telegram="@mkazmane"><span class="text-sm font-semibold">Mehdi Kazman (Lead)</span></div>
                                <div class="list-row clickable-person" data-name="Meryam Benoualidine" data-telegram="@meryam200"><span class="text-sm">Meryam Benoualidine</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GMS/GMW -->
                <div class="card-ent entity-box" data-entity="GMS">
                    <div class="p-5 flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-gray-900 text-base">GMS / GMW</h4>
                            <div class="text-[10px] text-gray-500 uppercase font-semibold mt-1">Combined Unit</div>
                        </div>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    
                    <div class="team-section">
                        <!-- GMS -->
                        <div class="border-b border-gray-100">
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Gmail Spam (GMS)</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Adil Jbilou Mnari" data-role="Team Leader" data-telegram="@mohammedmnari"><span class="text-sm font-semibold">Adil Jbilou Mnari (Lead)</span></div>
                                <div class="list-row clickable-person" data-name="Ayoub El Mahdi" data-telegram="@ayoubelmahdi"><span class="text-sm">Ayoub El Mahdi</span></div>
                                <div class="list-row clickable-person" data-name="Halima Es-sebyity" data-telegram="@Essebyity"><span class="text-sm">Halima Es-sebyity</span></div>
                                <div class="list-row clickable-person" data-name="Achraf Jebari" data-telegram="@achrafmaro"><span class="text-sm">Achraf Jebari</span></div>
                                <div class="list-row clickable-person" data-name="Firdaws El Haouzi" data-telegram="@firdaw123"><span class="text-sm">Firdaws El Haouzi</span></div>
                                <div class="list-row clickable-person" data-name="Adnan Bakkali"><span class="text-sm">Adnan Bakkali</span></div>
                                <div class="list-row clickable-person" data-name="Soulaimane El Harras"><span class="text-sm">Soulaimane El Harras</span></div>
                                <div class="list-row clickable-person" data-name="Fatima Zahrae Chaoui" data-telegram="@chaouiFatimazahrae"><span class="text-sm">Fatima Zahrae Chaoui</span></div>
                            </div>
                        </div>
                        <!-- GMW -->
                        <div>
                            <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                <span class="text-xs font-semibold text-gray-600">Yahoo Team (GMW)</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                            </div>
                            <div class="team-content bg-gray-50/50">
                                <div class="list-row clickable-person" data-name="Souhail Kabbour" data-role="Team Leader" data-telegram="@souhailkbr"><span class="text-sm font-semibold">Souhail Kabbour (Lead)</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sour El Maagazine -->
        <div class="mb-16" data-location="Sour El Maagazine">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="section-marker"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Sour El Maagazine</h2>
                </div>
                <button class="text-sm font-medium text-gray-500 hover:text-brand-purple transition-colors flex items-center gap-2 location-map-btn" 
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.787475691114!2d-5.814137823725026!3d35.780596524508454!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0c7f142e05ed99%3A0x8c6ad852c8e2742e!2sPI%20Marketing!5e0!3m2!1sen!2sma!4v1746104905595!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt"></i> View Map
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- GMA -->
                <div class="card-ent entity-box col-span-1 md:col-span-2" data-entity="GMA">
                    <div class="p-5 flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-gray-900 text-base">GMA</h4>
                        </div>
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <!-- Hatim Group -->
                        <div class="border-r border-gray-100">
                            <div class="p-4 flex items-center gap-3 clickable-person cursor-pointer bg-gray-50/50" data-name="Hatim Lachiri" data-role="Team Leader" data-telegram="@HatimLac">
                                <div class="w-8 h-8 rounded bg-gray-900 text-white flex items-center justify-center text-xs font-bold">HL</div>
                                <div>
                                    <div class="font-bold text-sm text-gray-900">Hatim Lachiri</div>
                                    <div class="text-[10px] text-gray-500 uppercase">Team Leader</div>
                                </div>
                            </div>
                            <div class="team-section">
                                <div class="border-b border-gray-100">
                                    <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                        <span class="text-xs font-semibold text-gray-600">Yahoo Team</span>
                                        <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                                    </div>
                                    <div class="team-content bg-gray-50/50">
                                        <div class="list-row clickable-person" data-name="Mohamed Stitou"><span class="text-sm font-semibold">Mohamed Stitou (Lead)</span></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                        <span class="text-xs font-semibold text-gray-600">Gmail Spam</span>
                                        <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                                    </div>
                                    <div class="team-content bg-gray-50/50">
                                        <div class="list-row clickable-person" data-name="Mehdi Eziyami" data-telegram="@mehdiigm"><span class="text-sm font-semibold">Mehdi Eziyami (Lead)</span></div>
                                        <div class="list-row clickable-person" data-name="Younes Benkirou"><span class="text-sm">Younes Benkirou</span></div>
                                        <div class="list-row clickable-person" data-name="FatimaZohra Marso"><span class="text-sm">FatimaZohra Marso</span></div>
                                        <div class="list-row clickable-person" data-name="Yassine Tahiri"><span class="text-sm">Yassine Tahiri</span></div>
                                        <div class="list-row clickable-person" data-name="Yousra El Filali"><span class="text-sm">Yousra El Filali</span></div>
                                        <div class="list-row clickable-person" data-name="Asmae Khalfi"><span class="text-sm">Asmae Khalfi</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ahmed Group -->
                        <div>
                            <div class="p-4 flex items-center gap-3 clickable-person cursor-pointer bg-gray-50/50" data-name="Ahmed Benjelloun Fahri" data-role="Team Leader">
                                <div class="w-8 h-8 rounded bg-gray-900 text-white flex items-center justify-center text-xs font-bold">AB</div>
                                <div>
                                    <div class="font-bold text-sm text-gray-900">Ahmed Benjelloun Fahri</div>
                                    <div class="text-[10px] text-gray-500 uppercase">Team Leader</div>
                                </div>
                            </div>
                            <div class="team-section">
                                <div>
                                    <div class="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors toggle-btn" onclick="toggleSection(this)">
                                        <span class="text-xs font-semibold text-gray-600">Others Team</span>
                                        <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                                    </div>
                                    <div class="team-content bg-gray-50/50">
                                        <div class="list-row clickable-person" data-name="Afaf Dahimi"><span class="text-sm">Afaf Dahimi</span></div>
                                        <div class="list-row clickable-person" data-name="Mohamed Farsani"><span class="text-sm">Mohamed Farsani</span></div>
                                        <div class="list-row clickable-person" data-name="Oumaima Maich"><span class="text-sm">Oumaima Maich</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riad Tetouan -->
        <div class="mb-16" data-location="Riad Tetouan">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="section-marker"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Riad Tetouan</h2>
                </div>
                <button class="text-sm font-medium text-gray-500 hover:text-brand-purple transition-colors flex items-center gap-2 location-map-btn" 
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1477.0876264023589!2d-5.801125955928066!3d35.77059454517391!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0b81ca76fe8ea9%3A0x288e0c1dc391b2d7!2sTangier%20Office%20Center!5e1!3m2!1sen!2sma!4v1746174355291!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt"></i> View Map
                </button>
            </div>

            <div class="card-ent entity-box" data-entity="EIN CONSULTING">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-xl">EIN CONSULTING</h4>
                        <div class="text-xs text-gray-500">IT & Development</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs font-bold text-gray-400 count-badge">0</span>
                        <div class="flex items-center gap-3 clickable-person bg-gray-50 px-4 py-2 rounded-lg cursor-pointer" data-name="Mohamed Aoujil" data-role="IT Manager" data-telegram="@aoujilmed">
                            <div class="text-right">
                                <div class="font-bold text-sm text-gray-900">Mohamed Aoujil</div>
                                <div class="text-[10px] text-brand-purple font-bold uppercase tracking-wide">IT Manager</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-100">
                    <!-- Reporting -->
                    <div class="p-5">
                        <div class="flex items-center gap-2 mb-4 text-gray-500">
                            <i class="fas fa-chart-line"></i>
                            <span class="text-sm font-bold uppercase tracking-wide">Reporting</span>
                        </div>
                        <div class="list-row clickable-person bg-gray-50 rounded-lg mb-2" data-name="Jihane El Moustaid" data-role="Manager">
                            <span class="text-sm font-semibold">Jihane El Moustaid</span>
                            <span class="text-[10px] text-gray-400 uppercase">Manager</span>
                        </div>
                        <div class="list-row clickable-person border-none" data-name="Hamza Nigriyya"><span class="text-sm">Hamza Nigriyya</span></div>
                    </div>

                    <!-- Support -->
                    <div class="p-5">
                        <div class="flex items-center gap-2 mb-4 text-gray-500">
                            <i class="fas fa-headset"></i>
                            <span class="text-sm font-bold uppercase tracking-wide">Support</span>
                        </div>
                        <div class="flex justify-between items-center px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors toggle-btn mb-2" onclick="toggleSection(this)">
                            <span class="text-xs font-medium text-gray-500 uppercase">Show Team</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 chevron"></i>
                        </div>
                        <div class="team-content">
                            <div class="list-row clickable-person" data-name="Abdellatif Mrini"><span class="text-sm">Abdellatif Mrini</span></div>
                            <div class="list-row clickable-person" data-name="Mohamed Abasidi"><span class="text-sm">Mohamed Abasidi</span></div>
                            <div class="list-row clickable-person" data-name="Abdelhay Amrani"><span class="text-sm">Abdelhay Amrani</span></div>
                            <div class="list-row clickable-person" data-name="Mouad El Mediouni"><span class="text-sm">Mouad El Mediouni</span></div>
                            <div class="list-row clickable-person" data-name="Hafsa M'bital"><span class="text-sm">Hafsa M'bital</span></div>
                            <div class="list-row clickable-person" data-name="Mohammed Ifri"><span class="text-sm">Mohammed Ifri</span></div>
                            <div class="list-row clickable-person" data-name="Abdelali Laatamli"><span class="text-sm">Abdelali Laatamli</span></div>
                            <div class="list-row clickable-person" data-name="Ilias Anouar"><span class="text-sm">Ilias Anouar</span></div>
                            <div class="list-row clickable-person" data-name="Najoua"><span class="text-sm">Najoua</span></div>
                        </div>
                    </div>

                    <!-- Dev -->
                    <div class="p-5">
                        <div class="flex items-center gap-2 mb-4 text-gray-500">
                            <i class="fas fa-code"></i>
                            <span class="text-sm font-bold uppercase tracking-wide">Development</span>
                        </div>
                        <div class="list-row clickable-person bg-gray-50 rounded-lg mb-2" data-name="Younes Zaidi" data-role="Lead Dev">
                            <span class="text-sm font-semibold">Younes Zaidi</span>
                            <span class="text-[10px] text-gray-400 uppercase">Lead</span>
                        </div>
                        <div class="list-row clickable-person" data-name="Ouarda Taimi"><span class="text-sm">Ouarda Taimi</span></div>
                        <div class="list-row clickable-person" data-name="Zakariyae Chmaili"><span class="text-sm">Zakariyae Chmaili</span></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    <div id="profileModal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-sm relative p-0" onclick="event.stopPropagation()">
            <div class="absolute top-0 left-0 right-0 h-24 bg-gradient-to-br from-gray-900 to-gray-800 rounded-t-2xl"></div>
            <button class="absolute top-4 right-4 text-white/80 hover:text-white z-10" onclick="closeModals()">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="pt-12 px-6 pb-8 text-center relative">
                <div class="w-20 h-20 mx-auto bg-white rounded-full flex items-center justify-center text-2xl font-bold mb-4 shadow-lg border-4 border-white relative z-10 text-gray-900">
                    <span id="modalInitials">AB</span>
                </div>
                <h3 id="modalName" class="text-2xl font-bold text-gray-900 mb-1">Name</h3>
                <p id="modalRole" class="text-brand-purple font-semibold text-xs uppercase tracking-widest">Role</p>
                
                <div class="mt-8 space-y-3 text-left">
                    <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 border border-gray-100">
                         <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-400 shadow-sm border border-gray-100"><i class="fas fa-users text-sm"></i></div>
                         <div>
                             <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wide">Team</p>
                             <p id="modalTeam" class="text-sm font-semibold text-gray-900">Team</p>
                         </div>
                    </div>
                     <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 border border-gray-100">
                         <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-400 shadow-sm border border-gray-100"><i class="fas fa-map-pin text-sm"></i></div>
                         <div>
                             <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wide">Location</p>
                             <p id="modalLocation" class="text-sm font-semibold text-gray-900">Location</p>
                         </div>
                    </div>
                    <a id="modalTelegramLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-3.5 rounded-lg bg-gray-900 text-white font-medium hover:bg-gray-800 transition-all shadow-lg shadow-gray-200 mt-6">
                        <i class="fab fa-telegram-plane"></i> <span>Message on Telegram</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-5xl h-[80vh] flex flex-col relative" onclick="event.stopPropagation()">
            <div class="p-4 flex justify-between items-center border-b border-gray-200">
                <h3 class="font-bold text-lg text-gray-900">Location Map</h3>
                <button class="text-gray-400 hover:text-gray-900 p-2" onclick="closeModals()"><i class="fas fa-times text-lg"></i></button>
            </div>
            <iframe id="mapFrame" class="w-full h-full bg-gray-100 rounded-b-2xl" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            updateStats();
            
            // Modal Backdrop Click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', closeModals);
            });

            // Person Click
            document.querySelectorAll('.clickable-person').forEach(item => {
                item.addEventListener('click', () => openProfile(item));
            });

            // Map Click
            document.querySelectorAll('.location-map-btn').forEach(btn => {
                btn.addEventListener('click', () => openMap(btn.dataset.map));
            });

            // Search
            document.getElementById('globalSearch').addEventListener('input', (e) => filterData(e.target.value));

            // Toggle Filter Panel
            document.getElementById('filterToggleBtn').addEventListener('click', () => {
                const panel = document.getElementById('filterPanel');
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            // Toggle Role Dropdown
            document.getElementById('roleDropdownBtn').addEventListener('click', (e) => {
                 e.stopPropagation();
                 document.getElementById('roleDropdown').classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if(!document.getElementById('roleDropdownBtn').contains(e.target)) {
                    document.getElementById('roleDropdown').classList.add('hidden');
                }
            });
        });

        /* --- Toggle Logic (Fixed for Isolation) --- */
        window.toggleSection = function(btn) {
            // Find the NEXT sibling that is the content
            // Assuming structure: Header -> Content
            const container = btn.parentElement; 
            const content = container.querySelector('.team-content') || btn.nextElementSibling;
            
            if (!content) return;

            const icon = btn.querySelector('.chevron');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                if(icon) icon.classList.remove('rotated');
            } else {
                content.classList.add('expanded');
                if(icon) icon.classList.add('rotated');
            }
        };

        window.expandAllTeams = () => {
            document.querySelectorAll('.team-content').forEach(el => {
                if(!el.classList.contains('expanded')) {
                    el.classList.add('expanded');
                    // Find trigger
                    const container = el.parentElement;
                    const icon = container.querySelector('.chevron');
                    if(icon) icon.classList.add('rotated');
                }
            });
        };

        window.collapseAllTeams = () => {
            document.querySelectorAll('.team-content').forEach(el => {
                if(el.classList.contains('expanded')) {
                    el.classList.remove('expanded');
                    const container = el.parentElement;
                    const icon = container.querySelector('.chevron');
                    if(icon) icon.classList.remove('rotated');
                }
            });
        };

        /* --- Stats --- */
        function updateStats() {
            const totalMembers = document.querySelectorAll('.clickable-person:not(.filtered-hidden)').length;
            document.getElementById('stat-members').innerText = totalMembers;

            const totalTeams = document.querySelectorAll('.entity-box:not(.filtered-hidden)').length;
            document.getElementById('stat-teams').innerText = totalTeams;

            // Count Badges
            document.querySelectorAll('.entity-box').forEach(box => {
                const count = box.querySelectorAll('.clickable-person:not(.filtered-hidden)').length;
                const badge = box.querySelector('.count-badge');
                if(badge) badge.innerText = count;
            });
        }

        /* --- Filtering --- */
        function initFilters() {
            const locSelect = document.getElementById('locationFilter');
            const mainLocations = ["California (Avenue Banafsaj)", "Sour El Maagazine", "Riad Tetouan"];
            
            mainLocations.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.textContent = l;
                locSelect.appendChild(opt);
            });

            locSelect.addEventListener('change', () => filterData(document.getElementById('globalSearch').value));

            // Populate Roles
            const roles = new Set();
            document.querySelectorAll('[data-role]').forEach(el => roles.add(el.dataset.role));
            const roleContainer = document.getElementById('roleDropdown');
            roles.forEach(role => {
                const div = document.createElement('div');
                div.className = "flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer";
                div.innerHTML = `<input type="checkbox" value="${role}" class="rounded text-brand-purple border-gray-300 focus:ring-brand-purple"><span class="ml-2 text-sm text-gray-700">${role}</span>`;
                div.querySelector('input').addEventListener('change', () => filterData(document.getElementById('globalSearch').value));
                roleContainer.appendChild(div);
            });
        }

        function filterData(searchTerm) {
            const term = searchTerm.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const selectedRoles = Array.from(document.querySelectorAll('#roleDropdown input:checked')).map(cb => cb.value);

            document.querySelector('.selected-role-text').textContent = selectedRoles.length ? `${selectedRoles.length} Roles` : 'All Roles';

            document.querySelectorAll('.clickable-person').forEach(person => {
                const name = person.dataset.name.toLowerCase();
                const role = (person.dataset.role || '').toLowerCase();
                const pLocRaw = (person.dataset.location || person.closest('[data-location]')?.dataset.location || '');
                
                let pLocNormalized = "";
                if(pLocRaw.includes("California")) pLocNormalized = "California (Avenue Banafsaj)";
                else if(pLocRaw.includes("Sour")) pLocNormalized = "Sour El Maagazine";
                else if(pLocRaw.includes("Riad")) pLocNormalized = "Riad Tetouan";
                else pLocNormalized = pLocRaw; 

                const matchTerm = !term || name.includes(term) || role.includes(term);
                const matchLoc = !locationFilter || pLocNormalized === locationFilter; 
                const matchRole = !selectedRoles.length || selectedRoles.includes(person.dataset.role);

                if(matchTerm && matchLoc && matchRole) {
                    person.classList.remove('filtered-hidden');
                    if(term) {
                        // Traverse parents to expand if searched
                        let parent = person.closest('.team-content');
                        if (parent && !parent.classList.contains('expanded')) {
                            parent.classList.add('expanded');
                            let container = parent.parentElement;
                            let icon = container.querySelector('.chevron');
                            if(icon) icon.classList.add('rotated');
                        }
                    }
                } else {
                    person.classList.add('filtered-hidden');
                }
            });

            document.querySelectorAll('.entity-box').forEach(box => {
                const visible = box.querySelectorAll('.clickable-person:not(.filtered-hidden)').length;
                box.style.display = visible ? 'block' : 'none';
            });
            
            document.querySelectorAll('[data-location]').forEach(section => {
                 const visibleBoxes = Array.from(section.querySelectorAll('.entity-box')).some(b => b.style.display !== 'none');
                 section.style.display = visibleBoxes ? 'block' : 'none';
            });
            
            updateStats();
        }

        /* --- Modals --- */
        function openProfile(el) {
            document.getElementById('modalName').innerText = el.dataset.name;
            document.getElementById('modalRole').innerText = el.dataset.role || 'Team Member';
            
            const nameParts = el.dataset.name.split(' ');
            const initials = (nameParts[0][0] + (nameParts[1] ? nameParts[1][0] : '')).toUpperCase();
            document.getElementById('modalInitials').innerText = initials;

            let team = el.dataset.team;
            if(!team) {
                const box = el.closest('.entity-box');
                if(box) team = box.dataset.entity;
            }
            document.getElementById('modalTeam').innerText = team || 'General';
            
            const loc = el.dataset.location || el.closest('[data-location]')?.dataset.location || 'Main Office';
            document.getElementById('modalLocation').innerText = loc;

            const tgBtn = document.getElementById('modalTelegramLink');
            if(el.dataset.telegram) {
                tgBtn.href = `https://t.me/${el.dataset.telegram.replace('@','')}`;
                tgBtn.style.display = 'flex';
            } else {
                tgBtn.style.display = 'none';
            }

            document.getElementById('profileModal').classList.remove('hidden');
            // Small delay for transition
            setTimeout(() => {
                document.getElementById('profileModal').classList.add('show');
            }, 10);
        }

        function openMap(url) {
            document.getElementById('mapFrame').src = url;
            document.getElementById('mapModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('mapModal').classList.add('show');
            }, 10);
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('show'));
            setTimeout(() => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden'));
                document.getElementById('mapFrame').src = '';
            }, 300);
        }

        /* --- Export --- */
        function exportPDF() {
            expandAllTeams();
            const element = document.querySelector('.org-chart-canvas');
            const nav = document.querySelector('.header-bar');
            nav.style.display = 'none';

            html2pdf().from(element).set({
                margin: 5,
                filename: 'traffic_loop_org_chart.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
            }).save().then(() => {
                nav.style.display = 'flex';
                collapseAllTeams();
            });
        }
    </script>
</body>
</html>


