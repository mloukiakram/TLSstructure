<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Loop | Organization</title>
    
    <!-- Premium Typography: Inter (Closest to Apple's San Francisco) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: { 
                        // Extracted from Logo
                        brand: {
                            dark: '#1d1d1f',    // Apple/Google Black
                            gray: '#86868b',    // Apple Gray
                            purple: '#8b5cf6',  // Traffic Loop Purple
                            light: '#F5F5F7',   // Premium Background
                            surface: '#FFFFFF'
                        }
                    },
                    boxShadow: {
                        'premium': '0 4px 24px rgba(0, 0, 0, 0.04)', // Ultra soft shadow
                        'premium-hover': '0 8px 32px rgba(0, 0, 0, 0.08)',
                        'floating': '0 12px 40px rgba(0, 0, 0, 0.12)',
                    },
                    borderRadius: {
                        'xl': '18px', // Smooth corners
                        '2xl': '24px',
                    },
                    transitionProperty: {
                        'height': 'height, max-height, opacity, margin',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CUPERTINO DESIGN SYSTEM --- */
        body {
            background-color: #F5F5F7;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Glass Header (Frosted) */
        .nav-blur {
            background: rgba(251, 251, 253, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Card Philosophy: "Content First" */
        .card-premium {
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.03); /* Barely visible shadow */
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border: 1px solid rgba(0,0,0,0.02); /* Micro-border for contrast */
            position: relative;
            overflow: hidden;
        }

        .card-premium:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
        }

        /* The "Loop" Accent - Subtle indication of Brand */
        .brand-indicator {
            width: 40px; height: 4px;
            background: #8b5cf6; /* Traffic Loop Purple */
            border-radius: 2px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        /* Typography Hierarchy */
        h1, h2, h3, h4 { letter-spacing: -0.02em; }
        
        /* Inputs */
        .input-premium {
            background: #e6e6e8; /* Darker input bg for contrast on white */
            border: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            color: #1d1d1f;
        }
        .input-premium:focus {
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15); /* Purple Focus Ring */
            outline: none;
        }

        /* Buttons: Apple Style Pills */
        .btn-pill {
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: #1d1d1f;
            color: white;
        }
        .btn-primary:hover { background: #333; transform: translateY(-1px); }
        
        .btn-secondary {
            background: #e8e8ed;
            color: #1d1d1f;
        }
        .btn-secondary:hover { background: #dcdce0; }

        /* Collapse Animation (Smooth) */
        .team-collapse {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s ease;
            opacity: 0;
        }
        .team-collapse.expanded {
            grid-template-rows: 1fr;
            opacity: 1;
            margin-top: 12px;
        }
        .team-collapse > div { overflow: hidden; }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(50, 50, 50, 0.4); /* Darker, sophisticated overlay */
            backdrop-filter: blur(8px);
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
            z-index: 100; position: fixed; inset: 0;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }

        .modal-card {
            transform: scale(0.94) translateY(16px);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .modal-overlay.show .modal-card { transform: scale(1) translateY(0); }

        /* Utilities */
        .filtered-hidden { display: none !important; }
        .clickable-person { cursor: pointer; border-radius: 8px; transition: background 0.2s; }
        .clickable-person:hover { background: #F5F5F7; }
        
        /* Print */
        @media print {
            body { background: white; }
            .no-print { display: none; }
            .card-premium { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
            .team-collapse { display: block !important; grid-template-rows: 1fr !important; opacity: 1 !important; }
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="nav-blur fixed top-0 w-full z-50 h-16 flex items-center">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <!-- Brand -->
            <div class="flex items-center gap-3">
                <img src="https://i.imgur.com/Paft0Df.png" alt="Traffic Loop" class="h-8 w-auto object-contain">
                <div class="h-4 w-[1px] bg-gray-300 mx-1"></div>
                <span class="text-sm font-medium text-brand-gray tracking-wide">Organization</span>
            </div>

            <!-- Global Search & Actions -->
            <div class="flex items-center gap-4 no-print">
                <!-- Search Bar -->
                <div class="relative hidden md:block group">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input type="text" id="globalSearch" placeholder="Search..." 
                           class="input-premium pl-9 pr-4 py-1.5 text-sm w-64 placeholder-gray-500">
                </div>
                
                <!-- Filters Trigger -->
                <button id="filterToggleBtn" class="btn-secondary w-8 h-8 flex items-center justify-center rounded-full text-sm">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Filters Panel (Hidden by default, slides down) -->
    <div id="filterPanel" class="fixed top-16 left-0 w-full bg-white/90 backdrop-blur-xl border-b border-gray-100 z-40 hidden transition-all duration-300 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex flex-col md:flex-row gap-6 items-center justify-between">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <select id="locationFilter" class="input-premium px-4 py-2 text-sm w-full md:w-48 cursor-pointer">
                    <option value="">All Locations</option>
                </select>
                <div class="relative w-full md:w-48">
                    <button id="roleDropdownBtn" class="input-premium px-4 py-2 text-sm w-full text-left flex justify-between items-center">
                        <span class="selected-role-text">All Roles</span>
                        <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                    </button>
                    <!-- Role Dropdown -->
                    <div id="roleDropdown" class="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-floating p-2 hidden border border-gray-100 max-h-60 overflow-y-auto">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="expandAllTeams()" class="text-xs font-semibold text-brand-purple hover:text-brand-dark transition-colors px-3 py-1">Expand All</button>
                <button onclick="collapseAllTeams()" class="text-xs font-semibold text-gray-500 hover:text-brand-dark transition-colors px-3 py-1">Collapse</button>
                <button onclick="exportPDF()" class="text-xs font-semibold text-gray-500 hover:text-brand-dark transition-colors px-3 py-1"><i class="fas fa-download mr-1"></i> PDF</button>
            </div>
        </div>
    </div>

    <!-- Main Canvas -->
    <main class="container mx-auto px-6 pt-32 pb-20 org-chart-canvas">
        
        <!-- Hero: Executive Leadership -->
        <div class="text-center mb-16 animate-fade-in">
            <h1 class="text-4xl font-bold text-brand-dark mb-4 tracking-tight">Leadership</h1>
            <p class="text-brand-gray text-lg max-w-2xl mx-auto">Traffic Loop Solutions structure overview.</p>
        </div>

        <div class="flex flex-col md:flex-row justify-center gap-8 mb-24">
            <!-- Manager Card -->
            <div class="card-premium w-full md:w-96 p-8 text-center cursor-pointer clickable-person" 
                 data-name="Salaheddine Elyaakoubi" data-role="Manager" data-location="Global" data-telegram="@Salaheddine_elyakoubi">
                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gray-50 flex items-center justify-center text-3xl text-brand-dark shadow-inner">
                    <img src="https://ui-avatars.com/api/?name=Salaheddine+E&background=random&color=fff&size=128" class="rounded-full w-full h-full object-cover opacity-90" alt="">
                </div>
                <h2 class="text-2xl font-bold text-brand-dark mb-1">Salaheddine Elyaakoubi</h2>
                <p class="text-brand-purple font-medium text-sm tracking-wide uppercase mb-4">Manager</p>
                <div class="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-xs font-semibold text-gray-600">
                    <i class="fas fa-globe-americas"></i> Global
                </div>
            </div>

            <!-- HR Card -->
            <div class="card-premium w-full md:w-96 p-8 text-center cursor-pointer clickable-person"
                 data-name="Ibrahim EL Maimouni" data-role="HR Manager" data-location="HQ" data-telegram="@Ibrahim_Elmimouni">
                 <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gray-50 flex items-center justify-center text-3xl text-brand-dark shadow-inner">
                    <img src="https://ui-avatars.com/api/?name=Ibrahim+E&background=random&color=fff&size=128" class="rounded-full w-full h-full object-cover opacity-90" alt="">
                </div>
                <h2 class="text-2xl font-bold text-brand-dark mb-1">Ibrahim EL Maimouni</h2>
                <p class="text-brand-purple font-medium text-sm tracking-wide uppercase mb-4">Human Resources</p>
                <div class="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-xs font-semibold text-gray-600">
                    <i class="fas fa-building"></i> Headquarters
                </div>
            </div>
        </div>

        <!-- Section Divider -->
        <div class="border-t border-gray-200 my-16"></div>

        <!-- Special Departments (Grid Layout) -->
        <div class="mb-20" data-location="Special Departments (California)">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-brand-dark">Specialized Departments</h3>
                    <p class="text-brand-gray text-sm">California Campus</p>
                </div>
                <!-- Map Button -->
                <button class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center location-map-btn"
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3305.733248043701!2d-118.2436849847898!3d34.05223422525514!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x80c2c75ddc27da13%3A0xe22fcd699d41e495!2sLos%20Angeles%2C%20CA%2C%20USA!5e0!3m2!1sen!2sus!4v1678888888888!5m2!1sen!2sus">
                    <i class="fas fa-map-marker-alt text-brand-purple"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Tech Dept -->
                <div class="card-premium p-6 flex flex-col h-full entity-box" data-entity="Technician">
                    <div class="brand-indicator"></div>
                    <div class="flex justify-between items-start mb-6">
                        <h4 class="font-bold text-lg">Technician</h4>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">SUPPORT</span>
                    </div>
                    <!-- Single Person -->
                    <div class="flex items-center gap-3 clickable-person p-2" data-name="Mohamed Alaoui" data-role="Tech Lead" data-team="Technician" data-telegram="+212636203456">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-sm">MA</div>
                        <div>
                            <div class="font-semibold text-sm">Mohamed Alaoui</div>
                            <div class="text-xs text-brand-gray">Technical Lead</div>
                        </div>
                    </div>
                </div>

                <!-- Offers -->
                <div class="card-premium p-6 flex flex-col h-full entity-box" data-entity="Offers Team">
                    <div class="brand-indicator"></div>
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg">Offers</h4>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">MARKETING</span>
                    </div>
                    <div class="mt-auto">
                        <button class="w-full text-left text-xs font-semibold text-brand-purple flex justify-between items-center py-2 toggle-btn" onclick="toggleTeam(this)">
                            <span>View Members</span>
                            <i class="fas fa-plus transition-transform"></i>
                        </button>
                        <div class="team-collapse">
                            <div class="space-y-1 pt-2">
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Bouchra Merroun" data-role="Offers" data-telegram="@B_chra">Bouchra Merroun</div>
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Imane Laboudi" data-role="Offers">Imane Laboudi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security -->
                <div class="card-premium p-6 flex flex-col h-full entity-box" data-entity="Security">
                    <div class="brand-indicator"></div>
                     <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg">Security</h4>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">FACILITY</span>
                    </div>
                    <div class="mt-auto">
                        <button class="w-full text-left text-xs font-semibold text-brand-purple flex justify-between items-center py-2 toggle-btn" onclick="toggleTeam(this)">
                            <span>View Staff</span>
                            <i class="fas fa-plus transition-transform"></i>
                        </button>
                        <div class="team-collapse">
                            <div class="space-y-1 pt-2">
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Abdelmoumen" data-role="Security">Abdelmoumen</div>
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Hamid" data-role="Security">Hamid</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cleaning -->
                <div class="card-premium p-6 flex flex-col h-full entity-box" data-entity="Cleaning">
                    <div class="brand-indicator"></div>
                     <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-lg">Cleaning</h4>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">FACILITY</span>
                    </div>
                    <div class="mt-auto">
                        <button class="w-full text-left text-xs font-semibold text-brand-purple flex justify-between items-center py-2 toggle-btn" onclick="toggleTeam(this)">
                            <span>View Staff</span>
                            <i class="fas fa-plus transition-transform"></i>
                        </button>
                        <div class="team-collapse">
                            <div class="space-y-1 pt-2">
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Mounia" data-role="Cleaning">Mounia</div>
                                <div class="clickable-person p-2 text-sm text-gray-700" data-name="Aziza" data-role="Cleaning">Aziza</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- California Main -->
        <div class="mb-20" data-location="California">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-brand-dark">California Operations</h3>
                    <p class="text-brand-gray text-sm">Main Office</p>
                </div>
                 <button class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center location-map-btn"
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.7368258798906!2d-5.8449250237249295!3d35.78184052443994!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0c79a01a02e7a7%3A0x3742104ecd03499a!2sTraffic%20loop%20solutions!5e0!3m2!1sen!2sma!4v1746104811818!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt text-brand-purple"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- GML Supervisor -->
                <div class="card-premium p-0 entity-box" data-entity="GML">
                    <div class="p-6 border-b border-gray-100">
                        <div class="brand-indicator"></div>
                        <h4 class="font-bold text-xl mb-4">GML</h4>
                        <div class="flex items-center gap-3 clickable-person" data-name="Hicham Mennour" data-role="Supervisor" data-telegram="@hichamwork">
                             <div class="w-10 h-10 rounded-full bg-brand-purple text-white flex items-center justify-center text-sm font-bold">HM</div>
                             <div>
                                <div class="font-bold text-sm">Hicham Mennour</div>
                                <div class="text-xs text-brand-gray uppercase tracking-wide">Supervisor</div>
                             </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50/50 rounded-b-[20px]">
                        <!-- Team 1 -->
                        <div class="mb-2">
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>OTHERS TEAM</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Mohamed khallouqi" data-telegram="@M_med_018">Mohamed khallouqi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Ihab Lamsaadi" data-telegram="@ihablams">Ihab Lamsaadi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Khalid Touil" data-telegram="@koli78">Khalid Touil</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Nadir Elabid" data-telegram="+212691936017">Nadir Elabid</div>
                                </div>
                            </div>
                        </div>
                        <!-- Team 2 -->
                        <div>
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>GMAIL TEAM</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Akram Mlouki" data-role="Team Leader">Akram Mlouki (Lead)</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Oumaima El Moussaoui" data-telegram="@ELMusauiOumaima">Oumaima El Moussaoui</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Charif Edrissi" data-telegram="+212680743979">Charif Edrissi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Khalid Mesbah" data-telegram="@khaledeeev">Khalid Mesbah</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GMK Supervisor -->
                <div class="card-premium p-0 entity-box" data-entity="GMK">
                    <div class="p-6 border-b border-gray-100">
                        <div class="brand-indicator"></div>
                        <h4 class="font-bold text-xl mb-4">GMK</h4>
                        <div class="flex items-center gap-3 clickable-person" data-name="Hamza Fellah" data-role="Supervisor" data-telegram="+212677510391">
                             <div class="w-10 h-10 rounded-full bg-brand-purple text-white flex items-center justify-center text-sm font-bold">HF</div>
                             <div>
                                <div class="font-bold text-sm">Hamza Fellah</div>
                                <div class="text-xs text-brand-gray uppercase tracking-wide">Supervisor</div>
                             </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50/50 rounded-b-[20px]">
                        <!-- Hotmail -->
                        <div class="mb-2">
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>HOTMAIL TEAM</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Marouane Latif" data-role="Team Leader" data-telegram="@marouanLatif">Marouane Latif (Lead)</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Mhamed Gssayer" data-telegram="@Mhagsa">Mhamed Gssayer</div>
                                </div>
                            </div>
                        </div>
                        <!-- Gmail -->
                        <div>
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>GMAIL TEAM</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Haitam Oullad Benhammou" data-role="Team Leader" data-telegram="@haitamouladbenhamou">Haitam O. Benhammou (Lead)</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Bouchra S'bai" data-telegram="+21698117856">Bouchra S'bai</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Naim Bellali" data-telegram="@Theusers212">Naim Bellali</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Houda Rossi" data-telegram="">Houda Rossi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Firdaous El Harrak" data-telegram="@hk_firdaous">Firdaous El Harrak</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Nadia Samadi" data-telegram="@NadiiaSamadi">Nadia Samadi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Yasir Babahammou" data-telegram="@babahammouyassir">Yasir Babahammou</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GM2 Supervisor -->
                 <div class="card-premium p-0 entity-box" data-entity="GM2">
                    <div class="p-6 border-b border-gray-100">
                        <div class="brand-indicator"></div>
                        <h4 class="font-bold text-xl mb-4">GM2</h4>
                        <div class="flex items-center gap-3 clickable-person" data-name="Ismail Semlali" data-role="Supervisor" data-telegram="@esmaelwork">
                             <div class="w-10 h-10 rounded-full bg-brand-purple text-white flex items-center justify-center text-sm font-bold">IS</div>
                             <div>
                                <div class="font-bold text-sm">Ismail Semlali</div>
                                <div class="text-xs text-brand-gray uppercase tracking-wide">Supervisor</div>
                             </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50/50 rounded-b-[20px]">
                        <div>
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>GMAIL INBOX</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Mehdi Kazman" data-role="Team Leader">Mehdi Kazman (Lead)</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Meryam Benoualidine">Meryam Benoualidine</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GMS/GMW -->
                 <div class="card-premium p-0 entity-box" data-entity="GMS">
                    <div class="p-6 border-b border-gray-100">
                        <div class="brand-indicator"></div>
                        <h4 class="font-bold text-xl mb-4">GMS / GMW</h4>
                         <div class="text-xs text-brand-gray mb-2">Combined Units</div>
                    </div>
                    <div class="p-4 bg-gray-50/50 rounded-b-[20px]">
                         <!-- GMS -->
                         <div class="mb-2">
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>GMAIL SPAM (GMS)</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Adil Jbilou Mnari" data-role="Team Leader">Adil Jbilou Mnari (Lead)</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Ayoub El Mahdi">Ayoub El Mahdi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Halima Es-sebyity">Halima Es-sebyity</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Achraf Jebari">Achraf Jebari</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Firdaws El Haouzi">Firdaws El Haouzi</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Adnan Bakkali">Adnan Bakkali</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Soulaimane El Harras">Soulaimane El Harras</div>
                                    <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Fatima Zahrae Chaoui">Fatima Zahrae Chaoui</div>
                                </div>
                            </div>
                        </div>
                        <!-- GMW -->
                        <div>
                             <button class="w-full text-left text-xs font-semibold text-gray-600 hover:text-brand-purple flex justify-between items-center py-2 px-2 rounded hover:bg-white transition-colors toggle-btn" onclick="toggleTeam(this)">
                                <span>YAHOO TEAM (GMW)</span>
                                <i class="fas fa-plus text-[10px] opacity-50"></i>
                            </button>
                            <div class="team-collapse pl-2">
                                <div class="space-y-1 border-l border-gray-200 pl-3 py-2">
                                    <div class="clickable-person p-1.5 text-sm font-semibold text-brand-dark" data-name="Souhail Kabbour" data-role="Team Leader">Souhail Kabbour (Lead)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sour El Maagazine -->
         <div class="mb-20" data-location="Sour El Maagazine">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-brand-dark">Sour El Maagazine</h3>
                    <p class="text-brand-gray text-sm">Marketing Hub</p>
                </div>
                 <button class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center location-map-btn"
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.787475691114!2d-5.814137823725026!3d35.780596524508454!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0c7f142e05ed99%3A0x8c6ad852c8e2742e!2sPI%20Marketing!5e0!3m2!1sen!2sma!4v1746104905595!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt text-brand-purple"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- GMA -->
                 <div class="card-premium p-0 entity-box col-span-1 md:col-span-2" data-entity="GMA">
                    <div class="p-6 border-b border-gray-100">
                        <div class="brand-indicator"></div>
                        <h4 class="font-bold text-xl mb-1">GMA</h4>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Hatim -->
                        <div>
                             <div class="flex items-center gap-3 clickable-person mb-4" data-name="Hatim Lachiri" data-role="Team Leader" data-telegram="@HatimLac">
                                <div class="w-10 h-10 rounded-full bg-brand-dark text-white flex items-center justify-center text-sm font-bold">HL</div>
                                <div>
                                    <div class="font-bold text-sm">Hatim Lachiri</div>
                                    <div class="text-xs text-brand-gray uppercase tracking-wide">Team Leader</div>
                                </div>
                            </div>
                            <!-- Sub Teams -->
                             <div class="pl-5 border-l-2 border-gray-100 space-y-2">
                                 <div>
                                    <button class="w-full text-left text-xs font-semibold text-gray-500 hover:text-brand-purple py-1 toggle-btn" onclick="toggleTeam(this)">Yahoo Team</button>
                                    <div class="team-collapse">
                                        <div class="pl-2 pt-1 pb-2">
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Mohamed Stitou">Mohamed Stitou (Lead)</div>
                                        </div>
                                    </div>
                                 </div>
                                 <div>
                                    <button class="w-full text-left text-xs font-semibold text-gray-500 hover:text-brand-purple py-1 toggle-btn" onclick="toggleTeam(this)">Gmail Spam</button>
                                    <div class="team-collapse">
                                        <div class="pl-2 pt-1 pb-2">
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Mehdi Eziyami">Mehdi Eziyami (Lead)</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Younes Benkirou">Younes Benkirou</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="FatimaZohra Marso">FatimaZohra Marso</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Yassine Tahiri">Yassine Tahiri</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Yousra El Filali">Yousra El Filali</div>
											<div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Asmae Khalfi">Asmae Khalfi</div>
                                        </div>
                                    </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Ahmed -->
                        <div>
                             <div class="flex items-center gap-3 clickable-person mb-4" data-name="Ahmed Benjelloun Fahri" data-role="Team Leader">
                                <div class="w-10 h-10 rounded-full bg-brand-dark text-white flex items-center justify-center text-sm font-bold">AB</div>
                                <div>
                                    <div class="font-bold text-sm">Ahmed Benjelloun Fahri</div>
                                    <div class="text-xs text-brand-gray uppercase tracking-wide">Team Leader</div>
                                </div>
                            </div>
                             <div class="pl-5 border-l-2 border-gray-100 space-y-2">
                                 <div>
                                    <button class="w-full text-left text-xs font-semibold text-gray-500 hover:text-brand-purple py-1 toggle-btn" onclick="toggleTeam(this)">Others Team</button>
                                    <div class="team-collapse">
                                        <div class="pl-2 pt-1 pb-2">
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Afaf Dahimi">Afaf Dahimi</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Mohamed Farsani">Mohamed Farsani</div>
                                            <div class="clickable-person p-1.5 text-sm text-gray-600" data-name="Oumaima Maich">Oumaima Maich</div>
                                        </div>
                                    </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riad Tetouan -->
        <div class="mb-12" data-location="Riad Tetouan">
             <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-brand-dark">Riad Tetouan</h3>
                    <p class="text-brand-gray text-sm">IT & Development</p>
                </div>
                 <button class="btn-secondary w-10 h-10 rounded-full flex items-center justify-center location-map-btn"
                    data-map="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1477.0876264023589!2d-5.801125955928066!3d35.77059454517391!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd0b81ca76fe8ea9%3A0x288e0c1dc391b2d7!2sTangier%20Office%20Center!5e1!3m2!1sen!2sma!4v1746174355291!5m2!1sen!2sma">
                    <i class="fas fa-map-marker-alt text-brand-purple"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                 <div class="card-premium p-0 entity-box col-span-1 md:col-span-2" data-entity="EIN CONSULTING">
                     <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                         <div>
                            <div class="brand-indicator"></div>
                            <h4 class="font-bold text-xl">EIN CONSULTING</h4>
                         </div>
                         <div class="flex gap-4">
                             <!-- IT Manager -->
                             <div class="text-right clickable-person p-2" data-name="Mohamed Aoujil" data-role="IT Manager" data-telegram="@aoujilmed">
                                 <div class="font-bold text-sm text-brand-dark">Mohamed Aoujil</div>
                                 <div class="text-xs text-brand-purple font-bold">IT MANAGER</div>
                             </div>
                         </div>
                     </div>
                     
                     <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-8">
                         <!-- Reporting -->
                         <div class="bg-gray-50 rounded-xl p-4">
                             <div class="flex items-center gap-2 mb-3">
                                 <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm"><i class="fas fa-chart-line text-xs"></i></div>
                                 <span class="font-bold text-sm">Reporting</span>
                             </div>
                             <!-- Reporting Manager -->
                             <div class="clickable-person p-2 mb-2 bg-white rounded-lg border border-gray-100 shadow-sm" data-name="Jihane El Moustaid" data-role="Manager">
                                 <div class="text-xs font-bold text-brand-dark">Jihane El Moustaid</div>
                                 <div class="text-[10px] text-gray-500">Manager</div>
                             </div>
                             <div class="space-y-1">
                                 <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Hamza Nigriyya">Hamza Nigriyya</div>
                             </div>
                         </div>

                         <!-- Support -->
                         <div class="bg-gray-50 rounded-xl p-4">
                             <div class="flex items-center gap-2 mb-3">
                                 <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm"><i class="fas fa-headset text-xs"></i></div>
                                 <span class="font-bold text-sm">Support</span>
                             </div>
                             <button class="w-full text-center text-xs text-brand-purple font-semibold py-2 bg-white rounded-lg border border-gray-100 hover:shadow-sm transition-shadow toggle-btn" onclick="toggleTeam(this)">Show Team</button>
                             <div class="team-collapse">
                                <div class="space-y-1 pt-2">
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Abdellatif Mrini">Abdellatif Mrini</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Mohamed Abasidi">Mohamed Abasidi</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Abdelhay Amrani">Abdelhay Amrani</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Mouad El Mediouni">Mouad El Mediouni</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Hafsa M'bital">Hafsa M'bital</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Mohammed Ifri">Mohammed Ifri</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Abdelali Laatamli">Abdelali Laatamli</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Ilias Anouar">Ilias Anouar</div>
                                    <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Najoua">Najoua</div>
                                </div>
                             </div>
                         </div>

                         <!-- Dev -->
                         <div class="bg-gray-50 rounded-xl p-4">
                             <div class="flex items-center gap-2 mb-3">
                                 <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm"><i class="fas fa-code text-xs"></i></div>
                                 <span class="font-bold text-sm">Development</span>
                             </div>
                             <div class="clickable-person p-2 mb-2 bg-white rounded-lg border border-gray-100 shadow-sm" data-name="Younes Zaidi" data-role="Lead Dev">
                                 <div class="text-xs font-bold text-brand-dark">Younes Zaidi</div>
                                 <div class="text-[10px] text-gray-500">Lead Developer</div>
                             </div>
                             <div class="space-y-1">
                                 <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Ouarda Taimi">Ouarda Taimi</div>
                                 <div class="clickable-person p-1.5 text-xs text-gray-600" data-name="Zakariyae Chmaili">Zakariyae Chmaili</div>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>
        </div>
    </main>

    <!-- Modal System -->
    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay flex items-center justify-center p-4">
        <div class="modal-card bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative" onclick="event.stopPropagation()">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-brand-dark z-10 p-2" onclick="closeModals()">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="p-8 text-center">
                <div class="w-20 h-20 mx-auto bg-brand-purple text-white rounded-full flex items-center justify-center text-2xl font-bold mb-4 shadow-lg shadow-purple-100">
                    <span id="modalInitials">AB</span>
                </div>
                <h3 id="modalName" class="text-xl font-bold text-brand-dark mb-1">Name</h3>
                <p id="modalRole" class="text-brand-purple font-medium text-sm uppercase tracking-wide">Role</p>
                
                <div class="mt-8 space-y-4 text-left">
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-gray-50 border border-gray-100">
                         <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-400 shadow-sm"><i class="fas fa-users"></i></div>
                         <div>
                             <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Team</p>
                             <p id="modalTeam" class="text-sm font-semibold text-gray-700">Team</p>
                         </div>
                    </div>
                     <div class="flex items-center gap-4 p-3 rounded-xl bg-gray-50 border border-gray-100">
                         <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-400 shadow-sm"><i class="fas fa-map-pin"></i></div>
                         <div>
                             <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Location</p>
                             <p id="modalLocation" class="text-sm font-semibold text-gray-700">Location</p>
                         </div>
                    </div>
                    <!-- Telegram Button -->
                    <a id="modalTelegramLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 rounded-xl bg-[#0088cc] text-white font-semibold hover:bg-[#0077b5] transition-colors shadow-sm mt-4">
                        <i class="fab fa-telegram-plane"></i> Contact via Telegram
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal-overlay flex items-center justify-center p-4">
        <div class="modal-card bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[70vh] flex flex-col overflow-hidden relative" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white">
                <h3 class="font-bold text-lg text-brand-dark">Location View</h3>
                <button class="text-gray-400 hover:text-brand-dark p-2" onclick="closeModals()"><i class="fas fa-times"></i></button>
            </div>
            <iframe id="mapFrame" class="w-full h-full bg-gray-100" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            
            // Modal Backdrop Click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', closeModals);
            });

            // Person Click
            document.querySelectorAll('.clickable-person').forEach(item => {
                item.addEventListener('click', () => openProfile(item));
            });

            // Map Click
            document.querySelectorAll('.location-map-btn').forEach(btn => {
                btn.addEventListener('click', () => openMap(btn.dataset.map));
            });

            // Search
            document.getElementById('globalSearch').addEventListener('input', (e) => filterData(e.target.value));

            // Toggle Filter Panel
            document.getElementById('filterToggleBtn').addEventListener('click', () => {
                document.getElementById('filterPanel').classList.toggle('hidden');
            });
            
            // Toggle Role Dropdown
            document.getElementById('roleDropdownBtn').addEventListener('click', (e) => {
                 e.stopPropagation();
                 document.getElementById('roleDropdown').classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if(!document.getElementById('roleDropdownBtn').contains(e.target)) {
                    document.getElementById('roleDropdown').classList.add('hidden');
                }
            });
        });

        /* --- Team Toggle (Smooth) --- */
        window.toggleTeam = function(btn) {
            const container = btn.parentElement;
            const collapse = container.querySelector('.team-collapse') || btn.nextElementSibling;
            const icon = btn.querySelector('.fa-plus');

            if(collapse.classList.contains('expanded')) {
                collapse.classList.remove('expanded');
                btn.classList.remove('text-brand-purple');
                if(icon) {
                    icon.classList.remove('fa-minus');
                    icon.classList.add('fa-plus');
                }
            } else {
                collapse.classList.add('expanded');
                btn.classList.add('text-brand-purple');
                if(icon) {
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-minus');
                }
            }
        };

        window.expandAllTeams = () => {
            document.querySelectorAll('.team-collapse').forEach(el => {
                if(!el.classList.contains('expanded')) {
                    const btn = el.parentElement.querySelector('.toggle-btn');
                    if(btn) toggleTeam(btn);
                }
            });
        };

        window.collapseAllTeams = () => {
            document.querySelectorAll('.team-collapse').forEach(el => {
                if(el.classList.contains('expanded')) {
                    const btn = el.parentElement.querySelector('.toggle-btn');
                    if(btn) toggleTeam(btn);
                }
            });
        };

        /* --- Filtering --- */
        function initFilters() {
            // Populate Location Select
            const locs = new Set();
            document.querySelectorAll('[data-location]').forEach(el => locs.add(el.dataset.location));
            const locSelect = document.getElementById('locationFilter');
            locs.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.textContent = l;
                locSelect.appendChild(opt);
            });
            locSelect.addEventListener('change', () => filterData(document.getElementById('globalSearch').value));

            // Populate Roles
            const roles = new Set();
            document.querySelectorAll('[data-role]').forEach(el => roles.add(el.dataset.role));
            const roleContainer = document.getElementById('roleDropdown');
            roles.forEach(role => {
                const div = document.createElement('div');
                div.className = "flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer";
                div.innerHTML = `<input type="checkbox" value="${role}" class="rounded text-brand-purple border-gray-300 focus:ring-brand-purple"><span class="ml-2 text-sm text-gray-700">${role}</span>`;
                div.querySelector('input').addEventListener('change', () => filterData(document.getElementById('globalSearch').value));
                roleContainer.appendChild(div);
            });
        }

        function filterData(searchTerm) {
            const term = searchTerm.toLowerCase();
            const location = document.getElementById('locationFilter').value;
            const selectedRoles = Array.from(document.querySelectorAll('#roleDropdown input:checked')).map(cb => cb.value);

            // Update text
            document.querySelector('.selected-role-text').textContent = selectedRoles.length ? `${selectedRoles.length} Roles Selected` : 'All Roles';

            document.querySelectorAll('.clickable-person').forEach(person => {
                const name = person.dataset.name.toLowerCase();
                const role = (person.dataset.role || '').toLowerCase();
                const pLoc = (person.dataset.location || person.closest('[data-location]')?.dataset.location || '').toLowerCase();
                
                const matchTerm = !term || name.includes(term) || role.includes(term);
                const matchLoc = !location || pLoc === location.toLowerCase();
                const matchRole = !selectedRoles.length || selectedRoles.includes(person.dataset.role);

                if(matchTerm && matchLoc && matchRole) {
                    person.classList.remove('filtered-hidden');
                    // Auto-expand parent if searching
                    if(term) {
                        const collapse = person.closest('.team-collapse');
                        if(collapse && !collapse.classList.contains('expanded')) {
                            const btn = collapse.parentElement.querySelector('.toggle-btn');
                            if(btn) toggleTeam(btn);
                        }
                    }
                } else {
                    person.classList.add('filtered-hidden');
                }
            });

            // Hide empty containers logic (simplified for brevity)
            document.querySelectorAll('.entity-box').forEach(box => {
                const visible = box.querySelectorAll('.clickable-person:not(.filtered-hidden)').length;
                box.style.display = visible ? 'flex' : 'none';
            });
        }

        /* --- Modals --- */
        function openProfile(el) {
            document.getElementById('modalName').textContent = el.dataset.name;
            document.getElementById('modalRole').textContent = el.dataset.role || 'Member';
            
            // Initials
            const nameParts = el.dataset.name.split(' ');
            const initials = (nameParts[0][0] + (nameParts[1] ? nameParts[1][0] : '')).toUpperCase();
            document.getElementById('modalInitials').textContent = initials;

            // Context
            let team = el.dataset.team;
            if(!team) {
                // Try to infer from header
                const box = el.closest('.entity-box');
                if(box) team = box.dataset.entity;
            }
            document.getElementById('modalTeam').textContent = team || 'General';
            
            const loc = el.dataset.location || el.closest('[data-location]')?.dataset.location || 'Main Office';
            document.getElementById('modalLocation').textContent = loc;

            // Telegram
            const tgBtn = document.getElementById('modalTelegramLink');
            if(el.dataset.telegram) {
                tgBtn.href = `https://t.me/${el.dataset.telegram.replace('@','')}`;
                tgBtn.style.display = 'flex';
            } else {
                tgBtn.style.display = 'none';
            }

            document.getElementById('profileModal').classList.add('show');
        }

        function openMap(url) {
            document.getElementById('mapFrame').src = url;
            document.getElementById('mapModal').classList.add('show');
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('show'));
            setTimeout(() => {
                document.getElementById('mapFrame').src = '';
            }, 300);
        }

        /* --- Export PDF --- */
        function exportPDF() {
            expandAllTeams();
            const element = document.querySelector('.org-chart-canvas');
            
            // Hide navbar/filters for print
            const nav = document.querySelector('nav');
            nav.style.display = 'none';

            html2pdf().from(element).set({
                margin: 10,
                filename: 'traffic_loop_org_chart.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
            }).save().then(() => {
                nav.style.display = 'flex';
                collapseAllTeams();
            });
        }
    </script>
</body>
</html>

